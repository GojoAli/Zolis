<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zolis · Connexion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div>
        <p class="eyebrow">Zolis</p>
        <h1>Connexion coureur</h1>
      </div>
    </header>

    <main class="content single">
      <section class="card form-card">
        <h2>Se connecter</h2>
        <form id="loginForm">
          <label>Email
            <input type="email" id="email" required />
          </label>
          <label>Mot de passe
            <input type="password" id="password" required minlength="8" />
          </label>
          <label>
            <input type="checkbox" id="newSession" />
            Créer une nouvelle session
          </label>
          <button type="submit">Entrer</button>
        </form>
        <p class="muted" id="statusMsg"></p>
        <p class="muted">
          Pas encore de compte ?
          <a class="inline-link" href="/register">Créer un compte</a>
        </p>
      </section>
    </main>
  </div>

  <script>
    const backend = "/api/backend";
    const statusMsg = document.getElementById("statusMsg");
    const form = document.getElementById("loginForm");

    async function parseJsonSafe(response) {
      const text = await response.text();
      if (!text) {
        return {};
      }
      try {
        return JSON.parse(text);
      } catch (err) {
        return { detail: text };
      }
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      statusMsg.textContent = "Connexion...";

      const payload = {
        email: document.getElementById("email").value.trim(),
        password: document.getElementById("password").value,
        new_session: document.getElementById("newSession").checked
      };

      try {
        const res = await fetch(`${backend}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await parseJsonSafe(res);
        if (!res.ok) {
          throw new Error(data.detail || data.error || `HTTP ${res.status}`);
        }
        if (!data.session_id) {
          throw new Error("session_id manquant");
        }

        const authRes = await fetch("/auth/session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (!authRes.ok) {
          throw new Error("session setup failed");
        }

        window.location.href = "/";
      } catch (err) {
        statusMsg.textContent = `Connexion impossible: ${err.message}`;
      }
    });
  </script>
</body>
</html>
